---

- name: TripleO inventory creation
  hosts: localhost
  gather_facts: no
  tasks:
    - name: TripleO Clouds Inventory
      ansible.builtin.import_role:
        name: tripleo_clouds_inventory

    - name: Update Infrared Workspace Inventory
      ansible.builtin.copy:
        src: "{{ environment_dir }}/inventory_{{ host }}"
        dest: "{{ inventory_dir }}/tripleo-inventory-hosts"

    - name: Generate Infrared Inventory
      vars:
        inventory_file_name: 'tripleo-inventory'
      ansible.builtin.import_role:
        name: inventory-update

    # Workaround  for infrared requirement of [overcloud_nodes] group
    # that is not generated by infrared inventory template
    - name: Append [overcloud_nodes] To Workspace Inventory If Required
      ansible.builtin.lineinfile:
        path: "{{ inventory_dir }}/hosts"
        regexp: '^\[overcloud_nodes\]$'
        line: "\n[overcloud_nodes]"
      when: "'overcloud_nodes' not in groups"
